# 사용자의 직위등의 위치에 따른 권한 설정
## 추후에 추가할 기능, 지금 당장에는 모두 공개, 모두 거부의 기능으로 설정

## 1. 모든 권한 
## 2. 모든 권한 없음
## 3. (추후에 추가) ex) 공사대장 접근 권한, 계약서류에 대한 접근 권한, 거래처 목록 접근 권한 등의 

따라서 모든 자료 테이블에는 권한 설정을 할 수 있어야 함

# 권한 관리 시스템

## 시스템 개요
이 문서는 시스템의 권한 관리 구조와 기능을 정의합니다.
사용자별 권한 설정, 역할 기반 접근 제어, 메뉴 접근 권한 등을 관리합니다.

## 주요 기능

### 1. 권한 그룹 관리
사용자 권한을 그룹화하여 관리합니다.
- 그룹 생성: 새로운 권한 그룹 생성
- 그룹 수정: 권한 그룹 정보 변경
- 그룹 삭제: 권한 그룹 삭제
- 그룹 조회: 권한 그룹 목록 조회

### 2. 권한 설정 관리
각 권한 그룹의 세부 권한을 관리합니다.
- 권한 할당: 그룹에 권한 할당
- 권한 수정: 할당된 권한 변경
- 권한 삭제: 할당된 권한 제거
- 권한 조회: 할당된 권한 목록 조회

### 3. 사용자 권한 관리
사용자별 권한을 관리합니다.
- 권한 부여: 사용자에게 권한 할당
- 권한 변경: 사용자 권한 수정
- 권한 회수: 사용자 권한 제거
- 권한 조회: 사용자 권한 목록 조회

## DB 연계
```sql
-- 권한 그룹 테이블: 권한 그룹의 기본 정보를 저장합니다.
-- 예: 관리자 그룹, 일반 사용자 그룹, 감사자 그룹 등을 관리합니다.
CREATE TABLE role_groups (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),  -- 그룹의 고유 식별자
    name VARCHAR(100) NOT NULL,                      -- 그룹명
    description TEXT,                                -- 그룹 설명
    is_system BOOLEAN DEFAULT FALSE,                 -- 시스템 그룹 여부
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,  -- 생성 일시
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP   -- 수정 일시
);

-- 권한 테이블: 시스템의 각 권한 정보를 저장합니다.
-- 예: 사용자 관리, 거래처 관리, 계약 관리 등의 권한을 관리합니다.
CREATE TABLE permissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),  -- 권한의 고유 식별자
    code VARCHAR(50) UNIQUE NOT NULL,                -- 권한 코드
    name VARCHAR(100) NOT NULL,                      -- 권한명
    description TEXT,                                -- 권한 설명
    module VARCHAR(50) NOT NULL,                     -- 소속 모듈
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,  -- 생성 일시
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP   -- 수정 일시
);

-- 그룹-권한 매핑 테이블: 권한 그룹과 권한 간의 관계를 저장합니다.
-- 예: 관리자 그룹에 사용자 관리, 거래처 관리 등의 권한을 할당합니다.
CREATE TABLE role_group_permissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),  -- 매핑의 고유 식별자
    role_group_id UUID REFERENCES role_groups(id),   -- 권한 그룹 ID
    permission_id UUID REFERENCES permissions(id),   -- 권한 ID
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,  -- 생성 일시
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,  -- 수정 일시
    UNIQUE(role_group_id, permission_id)             -- 그룹-권한 조합 유니크 제약
);

-- 사용자-그룹 매핑 테이블: 사용자와 권한 그룹 간의 관계를 저장합니다.
-- 예: 사용자 A를 관리자 그룹에 할당합니다.
CREATE TABLE user_role_groups (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),  -- 매핑의 고유 식별자
    user_id UUID REFERENCES users(id),               -- 사용자 ID
    role_group_id UUID REFERENCES role_groups(id),   -- 권한 그룹 ID
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,  -- 생성 일시
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,  -- 수정 일시
    UNIQUE(user_id, role_group_id)                   -- 사용자-그룹 조합 유니크 제약
);

-- 권한 이력 테이블: 권한 관련 변경 사항을 추적합니다.
-- 예: 권한 할당, 권한 변경, 권한 회수 등의 이력을 관리합니다.
CREATE TABLE permission_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),  -- 이력의 고유 식별자
    action_type VARCHAR(50) NOT NULL,                -- 작업 유형 (할당/변경/회수)
    target_type VARCHAR(50) NOT NULL,                -- 대상 유형 (그룹/사용자)
    target_id UUID NOT NULL,                         -- 대상 ID
    permission_id UUID REFERENCES permissions(id),   -- 권한 ID
    previous_data JSONB,                             -- 변경 전 데이터
    new_data JSONB,                                  -- 변경 후 데이터
    changed_by UUID REFERENCES users(id),            -- 변경 수행자 ID
    changed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP  -- 변경 일시
);
```

## 권한 체계
1. 권한 레벨
   - 시스템 관리자: 모든 권한
   - 부서 관리자: 부서 내 권한
   - 일반 사용자: 기본 권한
   - 감사자: 조회 권한

2. 권한 범위
   - 전체 권한: 모든 데이터 접근
   - 부서 권한: 소속 부서 데이터만 접근
   - 개인 권한: 본인 데이터만 접근

3. 권한 제한
   - 시간 제한: 특정 시간대만 접근
   - IP 제한: 특정 IP에서만 접근
   - 장치 제한: 특정 장치에서만 접근

## 보안 정책
1. 권한 관리
   - 최소 권한 원칙 적용
   - 정기적인 권한 검토
   - 권한 변경 이력 관리

2. 접근 제어
   - 역할 기반 접근 제어
   - 상황 기반 접근 제어
   - 다중 인증 요구

3. 감사
   - 권한 사용 로그 기록
   - 정기적인 감사 수행
   - 이상 징후 모니터링

# 권한 관리

## 권한 체계
1. 시스템 관리자
   - 모든 권한 보유
   - 사용자 관리
   - 시스템 설정

2. 부서 관리자
   - 부서 내 사용자 관리
   - 부서별 설정 관리
   - 부서별 보고서 조회

3. 현장 관리자
   - 현장 내 사용자 관리
   - 현장별 설정 관리
   - 현장별 보고서 조회

4. 분점 관리자
   - 분점 내 사용자 관리
   - 분점별 설정 관리
   - 분점별 보고서 조회

5. 일반 사용자
   - 기본 업무 수행
   - 개인 정보 관리
   - 권한 내 보고서 조회

## DB 연계
```sql
-- 권한 테이블
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 권한 상세 테이블
CREATE TABLE permissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    role_id UUID REFERENCES roles(id),
    module VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 사용자-권한 매핑 테이블
CREATE TABLE user_roles (
    user_id UUID REFERENCES users(id),
    role_id UUID REFERENCES roles(id),
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    assigned_by UUID REFERENCES users(id),
    PRIMARY KEY (user_id, role_id)
);
```

## 권한 부여 규칙
1. 기본 권한
   - 소속에 따른 기본 권한 자동 부여
   - 직급에 따른 기본 권한 자동 부여

2. 추가 권한
   - 관리자에 의한 수동 부여
   - 임시 권한 부여 가능
   - 권한 부여 이력 관리

3. 권한 제한
   - 최소 권한 원칙 적용
   - 권한 충돌 방지
   - 권한 승인 프로세스

## 권한 조회
1. 사용자별 권한 조회
```sql
SELECT r.name, p.module, p.action
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
JOIN permissions p ON r.id = p.role_id
WHERE u.id = '사용자ID';
```

2. 부서별 권한 조회
```sql
SELECT u.username, r.name as role_name
FROM users u
JOIN departments d ON u.department_id = d.id
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
WHERE d.id = '부서ID';
```

## 권한 변경 프로세스
1. 권한 요청
   - 사용자 권한 요청
   - 관리자 승인 필요

2. 권한 승인
   - 관리자 검토
   - 승인/거절 처리
   - 이력 관리

3. 권한 회수
   - 관리자 권한 회수
   - 자동 권한 회수
   - 이력 관리

